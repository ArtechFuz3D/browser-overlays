<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shadertoy Fire Particles â€“ Standalone</title>
<style>
html,body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: black;
}
canvas {
  width: 100vw;
  height: 100vh;
  display: block;
}
</style>
</head>
<body>
<canvas id="glcanvas"></canvas>

<script>
const canvas = document.getElementById("glcanvas");
const gl = canvas.getContext("webgl");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
  gl.viewport(0, 0, canvas.width, canvas.height);
}
addEventListener("resize", resize);
resize();

const vs = `
attribute vec2 position;
void main() {
  gl_Position = vec4(position, 0.0, 1.0);
}
`;

const fs = `
precision highp float;

uniform vec2 iResolution;
uniform float iTime;

#define MAX_NOISE_LAYERS 8
#define MAX_PARTICLE_LAYERS 20

float hash1_2(vec2 x){
  return fract(sin(dot(x, vec2(52.127,61.2871))) * 521.582);
}

vec2 hash2_2(vec2 x){
  return fract(sin(x * mat2(20.52,24.1994,70.291,80.171)) * 492.194);
}

vec2 noise2_2(vec2 uv){
  vec2 f = smoothstep(0.0,1.0,fract(uv));
  vec2 u = floor(uv);
  vec2 v00 = hash2_2(u);
  vec2 v01 = hash2_2(u+vec2(0,1));
  vec2 v10 = hash2_2(u+vec2(1,0));
  vec2 v11 = hash2_2(u+1.0);
  return mix(mix(v00,v01,f.y),mix(v10,v11,f.y),f.x);
}

float noise1_2(vec2 uv){
  vec2 f = fract(uv);
  vec2 u = floor(uv);
  float v00 = hash1_2(u);
  float v01 = hash1_2(u+vec2(0,1));
  float v10 = hash1_2(u+vec2(1,0));
  float v11 = hash1_2(u+1.0);
  return mix(mix(v00,v01,f.y),mix(v10,v11,f.y),f.x);
}

#define ANIMATION_SPEED 1.5
#define MOVEMENT_SPEED 1.0
#define MOVEMENT_DIRECTION vec2(0.7,-1.0)

#define PARTICLE_SIZE 0.009
#define PARTICLE_SCALE vec2(0.5,1.6)
#define PARTICLE_SCALE_VAR vec2(0.25,0.2)
#define PARTICLE_BLOOM_SCALE vec2(0.5,0.8)
#define PARTICLE_BLOOM_SCALE_VAR vec2(0.3,0.1)

#define SPARK_COLOR vec3(1.0,0.4,0.05)*1.5
#define BLOOM_COLOR vec3(1.0,0.4,0.05)*0.8
#define SMOKE_COLOR vec3(1.0,0.43,0.1)*0.8

#define SIZE_MOD 1.05
#define ALPHA_MOD 0.9
#define LAYERS_COUNT 15

float layeredNoise1_2(vec2 uv,float sizeMod,float alphaMod,int layers,float animation){
  float n=0.,a=1.,s=1.;
  vec2 off=vec2(0);
  for(int i=0;i<MAX_NOISE_LAYERS;i++){
    if(i>=layers) break;
    off+=hash2_2(vec2(a,s))*10.;
    n+=noise1_2(uv*s+iTime*animation*8.*MOVEMENT_DIRECTION*MOVEMENT_SPEED+off)*a;
    a*=alphaMod;
    s*=sizeMod;
  }
  return n*(1.-alphaMod)/(1.-pow(alphaMod,float(layers)));
}

vec2 rot(vec2 p,float a){
  float s=sin(a),c=cos(a);
  return mat2(s,c,-c,s)*p;
}

vec2 voronoiPointFromRoot(vec2 r,float d){
  vec2 p=(hash2_2(r)-.5)*.66;
  return mat2(sin(d),cos(d),-cos(d),sin(d))*p+r+.5;
}

float degFromRootUV(vec2 uv){
  return iTime*ANIMATION_SPEED*(hash1_2(uv)-.5)*2.;
}

vec2 randomAround2_2(vec2 p,vec2 r,vec2 uv){
  return p+(hash2_2(uv)-.5)*r;
}

vec3 fireParticles(vec2 uv,vec2 ouv){
  vec2 r=floor(uv);
  vec2 p=voronoiPointFromRoot(r,degFromRootUV(r));
  vec2 t=uv+(noise2_2(uv*2.)-.5)*.1-(noise2_2(uv*3.+iTime)-.5)*.07;
  float d=length(rot(t-p,.7)*randomAround2_2(PARTICLE_SCALE,PARTICLE_SCALE_VAR,r));
  float b=length(rot(t-p,.7)*randomAround2_2(PARTICLE_BLOOM_SCALE,PARTICLE_BLOOM_SCALE_VAR,r));
  vec3 c=(1.-smoothstep(PARTICLE_SIZE*.6,PARTICLE_SIZE*3.,d))*SPARK_COLOR;
  c+=pow(1.-smoothstep(0.,PARTICLE_SIZE*6.,b),3.)*BLOOM_COLOR;
  float e=1.-smoothstep((hash1_2(r)-.5)*2.,(hash1_2(r)-.5)*2.+.5,ouv.y);
  float a=smoothstep((hash1_2(r+.214)-1.8)*.7,(hash1_2(r+.214)-1.8)*.7+.4,ouv.y);
  return c*e*a;
}

vec3 layeredParticles(vec2 uv,float sm,float am,int l,float s){
  vec3 p=vec3(0);
  float a=1.,sz=1.;
  vec2 off=vec2(0);
  for(int i=0;i<MAX_PARTICLE_LAYERS;i++){
    if(i>=l) break;
    vec2 n=(noise2_2(uv*sz*2.+.5)-.5)*.15;
    vec2 buv=uv*sz+iTime*MOVEMENT_DIRECTION*MOVEMENT_SPEED+off+n;
    p+=fireParticles(buv,uv)*a*(1.-smoothstep(0.,1.,s)*(float(i)/float(l)));
    off+=hash2_2(vec2(a))*10.;
    a*=am; sz*=sm;
  }
  return p;
}

void main(){
  vec2 uv=(2.*gl_FragCoord.xy-iResolution.xy)/iResolution.x;
  float v=1.-smoothstep(.4,1.4,length(uv+vec2(0,.3)));
  uv*=1.8;
  float si=layeredNoise1_2(uv*10.+iTime*4.*MOVEMENT_DIRECTION*MOVEMENT_SPEED,1.7,.7,6,.2);
  si*=pow(1.-smoothstep(-1.,1.6,uv.y),2.);
  vec3 smoke=si*SMOKE_COLOR*.8*v;
  smoke*=pow(layeredNoise1_2(uv*4.+iTime*.5*MOVEMENT_DIRECTION*MOVEMENT_SPEED,1.8,.5,3,.2),2.)*1.5;
  vec3 col=(layeredParticles(uv,SIZE_MOD,ALPHA_MOD,LAYERS_COUNT,si)+smoke+SMOKE_COLOR*.02)*v;
  gl_FragColor=vec4(smoothstep(-.08,1.,col),1);
}
`;

function sh(type,src){
  const s=gl.createShader(type);
  gl.shaderSource(s,src);
  gl.compileShader(s);
  if(!gl.getShaderParameter(s,gl.COMPILE_STATUS))
    console.error(gl.getShaderInfoLog(s));
  return s;
}

const prog=gl.createProgram();
gl.attachShader(prog,sh(gl.VERTEX_SHADER,vs));
gl.attachShader(prog,sh(gl.FRAGMENT_SHADER,fs));
gl.linkProgram(prog);
gl.useProgram(prog);

const buf=gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER,buf);
gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([
  -1,-1, 1,-1, -1,1,
  -1,1, 1,-1, 1,1
]),gl.STATIC_DRAW);

const pos=gl.getAttribLocation(prog,"position");
gl.enableVertexAttribArray(pos);
gl.vertexAttribPointer(pos,2,gl.FLOAT,false,0,0);

const tLoc=gl.getUniformLocation(prog,"iTime");
const rLoc=gl.getUniformLocation(prog,"iResolution");

(function loop(t){
  gl.uniform1f(tLoc,t*.001);
  gl.uniform2f(rLoc,canvas.width,canvas.height);
  gl.drawArrays(gl.TRIANGLES,0,6);
  requestAnimationFrame(loop);
})(0);
</script>

</body>
</html>
